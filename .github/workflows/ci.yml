name: ci

on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      APPMETRICA_API_KEY: ${{ secrets.APPMETRICA_API_KEY }}
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
      KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
      KEYSTORE_STORE_PASSWORD: ${{ secrets.KEYSTORE_STORE_PASSWORD }}
      IS_DETEKT_TEST: 'false'
      IS_DEBUG: 'true'
      IS_RELEASE: 'false'
      IS_RELEASE_CLOUD: 'false'
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: setup jdk 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          cache-write-only: ${{ github.ref == 'refs/heads/main' }}

      - name: expose short commit sha
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - run: ./gradlew detekt test
        if: ${{ env.IS_DETEKT_TEST == 'true' }}

      - name: expose version
        run: ./gradlew -q printVersion | tee -a $GITHUB_ENV

      - name: assemble dev/uat/prod debug
        run: ./gradlew assembleDevDebug assembleUatDebug assembleProdDebug
        if: ${{ env.IS_DEBUG == 'true' }}

      - uses: actions/upload-artifact@v4
        if: ${{ env.IS_DEBUG == 'true' }}
        with:
          name: debug-apk-${{ env.VERSION_CODE }}
          path: app/build/outputs/apk/*/debug/*.apk
          retention-days: 1

      - name: expose debug apk paths
        if: ${{ env.IS_DEBUG == 'true' }}
        run: |
          dev_latest=$(ls -t app/build/outputs/apk/dev/debug/*.apk | head -1)
          uat_latest=$(ls -t app/build/outputs/apk/uat/debug/*.apk | head -1)
          prod_latest=$(ls -t app/build/outputs/apk/prod/debug/*.apk | head -1)
          echo "DEV_DEBUG_APK_PATH=$dev_latest" >> $GITHUB_ENV
          echo "UAT_DEBUG_APK_PATH=$uat_latest" >> $GITHUB_ENV
          echo "PROD_DEBUG_APK_PATH=$prod_latest" >> $GITHUB_ENV

      - name: telegram notify (debug dev)
        if: ${{ env.IS_DEBUG == 'true' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          MESSAGE: |
            #vp_client_dev
            
            ✅ <b>${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})</b>
            <b>Тип:</b> Debug (dev)
            <b>Ветка:</b> <code>${{ github.ref_name }}</code>
            <b>Коммит:</b> <code>${{ env.SHORT_SHA }}</code>
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document="@${DEV_DEBUG_APK_PATH}" \
            -F caption="${{ env.MESSAGE }}" \
            -F message_thread_id="${THREAD_ID}" \
            -F parse_mode="HTML"

      - name: telegram notify (debug uat)
        if: ${{ env.IS_DEBUG == 'true' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          MESSAGE: |
            #vp_client_uat
            
            ✅ <b>${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})</b>
            <b>Тип:</b> Debug (uat)
            <b>Ветка:</b> <code>${{ github.ref_name }}</code>
            <b>Коммит:</b> <code>${{ env.SHORT_SHA }}</code>
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document="@${UAT_DEBUG_APK_PATH}" \
            -F caption="${{ env.MESSAGE }}" \
            -F message_thread_id="${THREAD_ID}" \
            -F parse_mode="HTML"

      - name: telegram notify (debug prod)
        if: ${{ env.IS_DEBUG == 'true' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          MESSAGE: |
            #vp_client_prod
            
            ✅ <b>${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})</b>
            <b>Тип:</b> Debug (prod)
            <b>Ветка:</b> <code>${{ github.ref_name }}</code>
            <b>Коммит:</b> <code>${{ env.SHORT_SHA }}</code>
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document="@${PROD_DEBUG_APK_PATH}" \
            -F caption="${{ env.MESSAGE }}" \
            -F message_thread_id="${THREAD_ID}" \
            -F parse_mode="HTML"

      - name: decode keystore file
        id: decode_keystore_file
        uses: timheuer/base64-to-file@v1
        with:
          fileName: 'vpclient-keystore-release.jks'
          encodedString: ${{ secrets.KEYSTORE_FILE }}

      - name: set decoded keystore path
        run: echo "KEYSTORE_FILE=${{ steps.decode_keystore_file.outputs.filePath }}" >> $GITHUB_ENV

      - run: ./gradlew assembleRelease
        if: ${{ env.IS_RELEASE == 'true' }}

      - uses: actions/upload-artifact@v4
        if: ${{ env.IS_RELEASE == 'true' }}
        with:
          name: release-apk-${{ env.VERSION_CODE }}
          path: app/build/outputs/apk/release
          retention-days: 1

      - name: expose release apk path
        if: ${{ env.IS_RELEASE == 'true' }}
        run: |
          latest=$(ls -t app/build/outputs/apk/release/*.apk | head -1)
          echo "RELEASE_APK_PATH=$latest" >> $GITHUB_ENV

      - name: install aws cli v2
        if: ${{ env.IS_RELEASE_CLOUD == 'true' }}
        run: |
          sudo apt-get update && sudo apt-get install -y unzip
          curl -sSLo awscliv2.zip https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: upload apk to yandex storage
        if: ${{ env.IS_RELEASE_CLOUD == 'true' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.YC_S3_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_S3_SECRET_KEY }}
          AWS_DEFAULT_REGION: ru-central1
          YC_BUCKET: tmb
          YC_PREFIX: mca_android_vpclient
          YC_ENDPOINT: https://storage.yandexcloud.net
        run: |
          KEY_LATEST="${YC_PREFIX}/release/app-release.apk"
          aws --endpoint-url "$YC_ENDPOINT" s3 cp "$RELEASE_APK_PATH" "s3://${YC_BUCKET}/${KEY_LATEST}" \
            --acl public-read \
            --content-type application/vnd.android.package-archive \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-disposition "attachment; filename=\"VPClient-${VERSION_NAME}(${VERSION_CODE}).apk\"" \
            --metadata "version_name=${VERSION_NAME},version_code=${VERSION_CODE},sha=${SHORT_SHA}"
          echo "RELEASE_YC_URL=https://${YC_BUCKET}.storage.yandexcloud.net/${KEY_LATEST}" >> $GITHUB_ENV

      - name: telegram notify (release)
        if: ${{ env.IS_RELEASE == 'true' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          MESSAGE: |
            #vp_client_prod
            
            ✅ <b>${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})</b>
            <b>Тип:</b> Release
            <b>Ветка:</b> <code>${{ github.ref_name }}</code>
            <b>Коммит:</b> <code>${{ env.SHORT_SHA }}</code>
            <b>Ссылка на установку:</b> ${{ env.RELEASE_YC_URL }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
            -F chat_id="${CHAT_ID}" \
            -F document="@${RELEASE_APK_PATH}" \
            -F caption="${{ env.MESSAGE }}" \
            -F message_thread_id="${THREAD_ID}" \
            -F parse_mode="HTML"
